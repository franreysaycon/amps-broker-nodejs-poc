<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>4. State of the World (SOW) &#8212; Advanced Message Processing System (AMPS) Evaluation Guide 5.3.0.255
 documentation</title>
    
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '5.3.0.255',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="5. Advanced Topics" href="adv_topics.html" />
    <link rel="prev" title="3. Subscribe Publish and Subscribe" href="pub_sub.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/flag_logo.png" alt="Logo"/>
            </a></p>
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">4. State of the World (SOW)</a><ul>
<li><a class="reference internal" href="#how-does-the-state-of-the-world-work">How Does the State of the World Work?</a></li>
<li><a class="reference internal" href="#queries">Queries</a></li>
<li><a class="reference internal" href="#configuration">Configuration</a></li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
      <li>Previous: <a href="pub_sub.html" title="previous chapter">3. Subscribe Publish and Subscribe</a></li>
      <li>Next: <a href="adv_topics.html" title="next chapter">5. Advanced Topics</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="state-of-the-world-sow">
<h1>4. State of the World (SOW)<a class="headerlink" href="#state-of-the-world-sow" title="Permalink to this headline">¶</a></h1>
<p id="index-0">One of the core features of AMPS is the ability to persist the most
recent update for each message matching a topic. The State of the World
can be thought of as a database where messages published to AMPS are
filtered into topics, and where the topics store the latest update to a
message. Since AMPS subscriptions are based on the combination of topics
and filters, the State of the World (SOW) gives subscribers the ability
to quickly resolve any differences between their data and updated data
in the SOW by querying the current state of a topic, or a set of
messages inside a topic.</p>
<div class="section" id="how-does-the-state-of-the-world-work">
<span id="sow-how-does-it-work"></span><h2>How Does the State of the World Work?<a class="headerlink" href="#how-does-the-state-of-the-world-work" title="Permalink to this headline">¶</a></h2>
<p>Much like tables in a relational database, topics in the AMPS State of
the World persist the most recent update for each message. AMPS
identifies a message by using a unique key for the message. The SOW key
for a given message is similar to the primary key in a relational
database: each value of the key is a unique message. The first time a
message is received with a particular SOW key, AMPS adds the message to
the SOW. Subsequent messages with the same SOW key value update the
message.</p>
<p>There are several ways to create a SOW key for a message:</p>
<ul class="simple">
<li>Most applications specify that AMPS assigns a SOW key based on the
content of the message. The fields to use for the key are specified
in the SOW topic definition, and consist of one or more XPath
expressions. AMPS finds the specified fields in the message and
computes a SOW key based on the name of the topic and the values in
these fields. 60East recommends this approach unless an application
has a specific need for a different approach.</li>
<li>A topic can also be configured to require that a publisher provide a
SOW key for each message when publishing the message to AMPS.</li>
<li>AMPS also supports the ability for custom SOW key generation logic to
be defined in an AMPS module, which will be invoked to generate the
SOW key for each message. While these SOW keys are generated
automatically by AMPS, rather than being provided by the publisher,
the logic to generate these keys is provided by the module, and the
configuration required (if any) is determined by the module.</li>
</ul>
<p>The following diagrams demonstrate how the SOW works, using a SOW topic
that is configured to have AMPS determine the SOW key based on the
<code class="docutils literal"><span class="pre">/orderId</span></code> field within the message. As each message comes in, AMPS
uses the contents of the <code class="docutils literal"><span class="pre">/orderId</span></code> field to generate a SOW key for
the message. The SOW key is used to identify unique records in the SOW,
so AMPS will store a distinct record for each distinct <code class="docutils literal"><span class="pre">/orderId</span></code>
value published to this topic. The calculated SOW key will be returned
in the <code class="docutils literal"><span class="pre">SowKey</span></code> header of messages received from the topic in the SOW.</p>
<div class="figure" id="fig-sow-ex1">
<a class="reference internal image-reference" href="../_images/sow_overview_1.svg"><img alt="../_images/sow_overview_1.svg" src="../_images/sow_overview_1.svg" width="75.0%" /></a>
</div>
<p><strong>Figure 4.1:</strong> <em>A SOW topic named ORDERS with a key definition of /orderId</em></p>
<p>In <a class="reference internal" href="#fig-sow-ex1"><span class="std std-ref">Figure 4.1</span></a>, two messages are published where neither of the
messages have matching keys existing in the <code class="docutils literal"><span class="pre">ORDERS</span></code> topic, the
messages are both inserted as new messages. Some time after these
messages are processed, an update comes in for the order with an
<code class="docutils literal"><span class="pre">orderId</span></code> of <code class="docutils literal"><span class="pre">2</span></code>. This message changes the price from 120 to 95.
Since the incoming message has an <code class="docutils literal"><span class="pre">orderId</span></code> of 2, this matches an
existing record and overwrites the existing message for the same SOW
key, as seen in <a class="reference internal" href="#fig-sow-ex2"><span class="std std-ref">Figure 4.2</span></a>. AMPS replaces the entire record
with the contents of the update.</p>
<div class="figure" id="fig-sow-ex2">
<a class="reference internal image-reference" href="../_images/sow_overview_2.svg"><img alt="../_images/sow_overview_2.svg" src="../_images/sow_overview_2.svg" width="75.0%" /></a>
</div>
<p><strong>Figure 4.2:</strong> <em>Updating the IBM record by matching incoming message keys</em></p>
<p>Although the SOW key is derived from the content of the message in many
cases, the SOW key is distinct from the content of the message. Each
record in a SOW topic has a distinct SOW key, which is stored with the
record.</p>
<p>By default, a topic recorded in the State of the World is <em>persistent</em>.
For these topics, AMPS stores the contents of the state of the world for
that topic in a dedicated, memory-mapped file. This means that the total
state of the world does not need to fit into memory, and that the
contents of the state of the world database are maintained across server
restarts. You can also define a <em>transient</em> state of the world topic,
which does not store the contents of the SOW to a persisted file.</p>
<p id="index-1">The state of the world file is separate from the transaction log, and
you do not need to configure a transaction log to use a SOW. When a
transaction log is present that covers the SOW topic, on restart AMPS
uses the transaction log to keep the SOW up to date. When the latest
transaction in the SOW is more recent than the last transaction in the
transaction log (for example, if the transaction log has been deleted),
AMPS takes no action. If the transaction log has newer transactions than
the SOW, AMPS replays those transactions into the SOW to bring the SOW
file up to date. If the SOW file is missing or damaged, AMPS rebuilds
the state of the world by replaying the transaction log from the
beginning of the log.</p>
<p>When the State of the World for a topic is <em>transient</em>, AMPS does not
store the state of the world for this topic across restarts. In this
case, AMPS will synchronize the state of the world with the
transaction log when the server starts by default. You can use the
<cite>RecoveryPoint</cite> contfiguration option to specify that the topic
should have only new publishes, or should recover from a specific
point in time (for example, you could use an environment variable
to provide a timestamp to the <cite>RecoveryPoint</cite> so that AMPS
recovers only the last day&#8217;s worth of messages.)</p>
</div>
<div class="section" id="queries">
<span id="sow-queries"></span><h2>Queries<a class="headerlink" href="#queries" title="Permalink to this headline">¶</a></h2>
<p id="index-2">At any point in time, applications can issue SOW queries to retrieve all
of the messages that match a given topic and content filter. When a
query is executed, AMPS will test each message in the SOW against the
content filter specified and all messages matching the filter will be
returned to the client. The topic can be a literal topic name or a
regular expression pattern. For more information on issuing queries,
please see <a class="reference external" href="../../../user-guide/html/chapters/sow_queries.html">SOW Queries</a> in the AMPS User Guide.</p>
<span class="target" id="sow-config"></span></div>
<div class="section" id="configuration">
<h2>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h2>
<p id="index-3">Topics where SOW persistence is desired are individually configured
within the <code class="docutils literal"><span class="pre">SOW</span></code> section of the configuration file. Each topic will be
defined with a <code class="docutils literal"><span class="pre">Topic</span></code> section enclosed within <code class="docutils literal"><span class="pre">SOW</span></code>. The <em>AMPS
Configuration Reference</em> contains a description of the attributes that
can be configured per topic. <code class="docutils literal"><span class="pre">TopicMetaData</span></code> is a synonym for <code class="docutils literal"><span class="pre">SOW</span></code>
provided for compatibility with previous versions of AMPS. Likewise,
<code class="docutils literal"><span class="pre">TopicDefinition</span></code> is a synonym for the <code class="docutils literal"><span class="pre">Topic</span></code> element of the SOW
section, provided for compatibility with versions of AMPS prior to 5.0.</p>
<p>For the set of configuration options available in a SOW topic, see <a class="reference external" href="../../../configuration/html/chapters/sow.html#sow-topic">SOW/Topic</a> in the <a class="reference external" href="../../../configuration/html/index.html">AMPS Configuration Reference</a>.</p>
<p>The listing in <a class="reference internal" href="#sow-topic-config"><span class="std std-ref">Example 4.1</span></a>
is an example of using <code class="docutils literal"><span class="pre">Topic</span></code> to add a SOW topic to the AMPS configuration. One topic named
<code class="docutils literal"><span class="pre">ORDERS</span></code> is defined as having key <code class="docutils literal"><span class="pre">/invoice</span></code>, <code class="docutils literal"><span class="pre">/customerId</span></code> and <code class="docutils literal"><span class="pre">MessageType</span></code>
of <code class="docutils literal"><span class="pre">json</span></code>. The persistence file for this topic be saved in the
<code class="docutils literal"><span class="pre">sow/ORDERS.json.sow</span></code> file. For every message published to the
<code class="docutils literal"><span class="pre">ORDERS</span></code> topic, a unique key will be assigned to each record with a
unique combination of the fields <code class="docutils literal"><span class="pre">/invoice</span></code> and <code class="docutils literal"><span class="pre">/customerId</span></code>. A
second topic named <code class="docutils literal"><span class="pre">ALERTS</span></code> is also defined with a <code class="docutils literal"><span class="pre">MessageType</span></code> of
<code class="docutils literal"><span class="pre">xml</span></code> keyed off of <code class="docutils literal"><span class="pre">/client/id</span></code>. The SOW persistence file for
<code class="docutils literal"><span class="pre">ALERTS</span></code> is saved in the <code class="docutils literal"><span class="pre">sow/ALERTS.xml.sow</span></code> file.</p>
<div class="highlight-XML" id="sow-topic-config"><div class="highlight"><pre><span></span><span class="nt">&lt;SOW&gt;</span>
    <span class="nt">&lt;Topic&gt;</span>
        <span class="nt">&lt;Name&gt;</span>ORDERS<span class="nt">&lt;/Name&gt;</span>
        <span class="nt">&lt;FileName&gt;</span>sow/%n.sow<span class="nt">&lt;/FileName&gt;</span>
        <span class="nt">&lt;Key&gt;</span>/invoice<span class="nt">&lt;/Key&gt;</span>
        <span class="nt">&lt;Key&gt;</span>/customerId<span class="nt">&lt;/Key&gt;</span>
        <span class="nt">&lt;MessageType&gt;</span>json<span class="nt">&lt;/MessageType&gt;</span>
        <span class="nt">&lt;SlabSize&gt;</span>1MB<span class="nt">&lt;/SlabSize&gt;</span>
        <span class="nt">&lt;HashIndex&gt;</span>
            <span class="nt">&lt;Key&gt;</span>/region<span class="nt">&lt;/Key&gt;</span>
        <span class="nt">&lt;/HashIndex&gt;</span>
    <span class="nt">&lt;/Topic&gt;</span>

    <span class="nt">&lt;Topic&gt;</span>
        <span class="nt">&lt;Name&gt;</span>ALERTS<span class="nt">&lt;/Name&gt;</span>
        <span class="nt">&lt;FileName&gt;</span>sow/%n.sow<span class="nt">&lt;/FileName&gt;</span>
        <span class="nt">&lt;Key&gt;</span>/alert/id<span class="nt">&lt;/Key&gt;</span>
        <span class="nt">&lt;MessageType&gt;</span>xml<span class="nt">&lt;/MessageType&gt;</span>
        <span class="c">&lt;!-- Pregenerate an index for the /alert/type element. This is seldom necessary,</span>
<span class="c">             since AMPS will generate the index when it is needed, but the directive is included here</span>
<span class="c">             for example purposes. --&gt;</span>
        <span class="nt">&lt;Index&gt;</span>/alert/type<span class="nt">&lt;/Index&gt;</span>
    <span class="nt">&lt;/Topic&gt;</span>
<span class="nt">&lt;/SOW&gt;</span>
</pre></div>
</div>
<p><strong>Example 4.1:</strong> <em>Sample SOW Configuration</em></p>
<table border="1" class="docutils">
<colgroup>
<col width="12%" />
<col width="88%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><img alt="tip" src="../_images/tip.svg" /></td>
<td><p class="first">Topics are scoped by their message type.</p>
<p>For example, two topics named Orders can be created one which
supports <code class="docutils literal"><span class="pre">MessageType</span></code> of <code class="docutils literal"><span class="pre">json</span></code> and another which supports
<code class="docutils literal"><span class="pre">MessageType</span></code> of <code class="docutils literal"><span class="pre">xml</span></code>.</p>
<p>Each of the <code class="docutils literal"><span class="pre">MessageType</span></code> entries that are defined for the
<code class="docutils literal"><span class="pre">Orders</span></code> topic will require that <code class="docutils literal"><span class="pre">Transport</span></code> in the
configuration file can accept messages of that type. Otherwise,
there is no way for a publisher to publish messages of that type
to this instance or for a subscriber to receive messages of that
type from this instance.</p>
<p class="last">This means that messages published to the <code class="docutils literal"><span class="pre">Orders</span></code> topic must
know the type of message they are sending (<code class="docutils literal"><span class="pre">json</span></code> or <code class="docutils literal"><span class="pre">xml</span></code>)
and the port defined by the transport.</p>
</td>
</tr>
</tbody>
</table>
</div>
</div>


          </div>
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;2019, 60East Technologies, Inc..
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>