<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>15. Message Queues &#8212; AMPS User Guide 5.3.0.255
 documentation</title>
    
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '5.3.0.255',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="16. Message Types" href="messageTypes.html" />
    <link rel="prev" title="14. Transactional Messaging and Bookmark Subscriptions" href="txlog.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/flag_logo.png" alt="Logo"/>
            </a></p>
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">15. Message Queues</a><ul>
<li><a class="reference internal" href="#getting-started-with-amps-queues">Getting Started with AMPS Queues</a></li>
<li><a class="reference internal" href="#understanding-amps-queuing">Understanding AMPS Queuing</a><ul>
<li><a class="reference internal" href="#delivery-semantics">Delivery Semantics</a><ul>
<li><a class="reference internal" href="#choosing-delivery-semantics-to-handle-failures">Choosing Delivery Semantics To Handle Failures</a></li>
</ul>
</li>
<li><a class="reference internal" href="#subscription-backlog">Subscription Backlog</a></li>
<li><a class="reference internal" href="#delivery-fairness">Delivery Fairness</a></li>
<li><a class="reference internal" href="#priority-queues">Priority Queues</a></li>
<li><a class="reference internal" href="#acknowledging-messages">Acknowledging Messages</a></li>
<li><a class="reference internal" href="#message-flow-for-queues">Message Flow for Queues</a></li>
<li><a class="reference internal" href="#advanced-messaging-and-queues">Advanced Messaging and Queues</a><ul>
<li><a class="reference internal" href="#querying-queues-as-a-view">Querying Queues as a View</a></li>
<li><a class="reference internal" href="#topic-in-the-state-of-the-world-as-an-underlying-topic-for-a-queue">Topic in the State of the World as an Underlying Topic for a Queue</a></li>
<li><a class="reference internal" href="#delta-messaging-with-queues">Delta Messaging with Queues</a></li>
<li><a class="reference internal" href="#views-and-aggregated-subscriptions-over-queues">Views and Aggregated Subscriptions over Queues</a></li>
<li><a class="reference internal" href="#bookmark-subscriptions-to-queues">Bookmark Subscriptions to Queues</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#replacing-queue-subscriptions">Replacing Queue Subscriptions</a><ul>
<li><a class="reference internal" href="#handling-unprocessed-messages">Handling Unprocessed Messages</a></li>
<li><a class="reference internal" href="#using-multiple-underlying-topics">Using Multiple Underlying Topics</a></li>
</ul>
</li>
<li><a class="reference internal" href="#queue-subscriptions-compared-to-bookmark-replays">Queue Subscriptions Compared to Bookmark Replays</a></li>
<li><a class="reference internal" href="#sow-queue-and-sow-localqueue">SOW/Queue and SOW/LocalQueue</a></li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
      <li>Previous: <a href="txlog.html" title="previous chapter">14. Transactional Messaging and Bookmark Subscriptions</a></li>
      <li>Next: <a href="messageTypes.html" title="next chapter">16. Message Types</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="message-queues">
<span id="ug-queues"></span><h1>15. Message Queues<a class="headerlink" href="#message-queues" title="Permalink to this headline">Â¶</a></h1>
<p id="index-0">AMPS includes high performance queuing built on
the AMPS messaging engine and transaction log. AMPS message queues
combine elements of classic message queuing with the advanced messaging
features of AMPS, including content filtering, aggregation and
projection, historical replay, and so on. This chapter presents an
overview of queues.</p>
<p>AMPS message queues help you easily solve some common messaging
problems:</p>
<ul class="simple">
<li>Ensuring that a message is only processed once</li>
<li>Distributing tasks across workers in a fair manner</li>
<li>Ensuring that a message is delivered to and processed by a worker</li>
<li>Ensuring that when a worker fails to process a message, that message
is redelivered</li>
<li>Setting limits for retries in processing a message, and taking an
action when those limits are exceeded (such as moving the message to
a dead-letter queue).</li>
</ul>
<p>While it&#8217;s possible to create applications with these properties by
using the other features of AMPS, message queues provide these functions
built into the AMPS server. In addition, message queues allow you to:</p>
<ul class="simple">
<li>Replicate messages between AMPS instances while preserving delivery
guarantees</li>
<li>Create views and aggregates based on the current contents of a queue</li>
<li>Filter messages into and out of a queue</li>
<li>Provide a single published message to multiple queues</li>
<li>Aggregate multiple topics into a single queue</li>
</ul>
<p>Use message queues when you need to ensure that a message is processed
by a single consumer. When you need to distribute messages to a number
of consumers, use the AMPS pub/sub delivery model.</p>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><img alt="tip" src="../_images/tip.svg" /></td>
<td>Use message queues when it is important to ensure that a message
is processed once, by a single consumer. When it is important
to distribute messages to a number of consumers, use the AMPS
pub/sub delivery model rather than message queues.</td>
</tr>
</tbody>
</table>
<p>The following diagram illustrates a simple usage of a queue to
distribute work across three consumers.</p>
<a class="reference internal image-reference" href="../_images/queue_usage_overview.svg"><img alt="../_images/queue_usage_overview.svg" src="../_images/queue_usage_overview.svg" width="80.0%" /></a>
<p>This diagram shows a simple use of AMPS queues to distribute work. In
the diagram, the transaction log is configured to record a topic named
<code class="docutils literal"><span class="pre">Work</span></code>. AMPS is also configured with a a queue named <code class="docutils literal"><span class="pre">WorkToDo</span></code>,
which is based on the underlying topic <code class="docutils literal"><span class="pre">Work</span></code>. The publisher publishes
three messages to the topic <code class="docutils literal"><span class="pre">Work</span></code>, and AMPS includes those messages
in the <code class="docutils literal"><span class="pre">WorkToDo</span></code> queue. Each message is delivered to one of the three
subscribers to the <code class="docutils literal"><span class="pre">WorkToDo</span></code> queue. Unlike pub/sub messaging, each
subscriber only receives one message, and each message is delivered to
only one subscriber.</p>
<p>Notice that, even though AMPS provides queue semantics over the
<code class="docutils literal"><span class="pre">WorkToDo</span></code> topic, the messages are recorded in the transaction log
once, in the <code class="docutils literal"><span class="pre">Work</span></code> topic. Other subscribers could subscribe to the
<code class="docutils literal"><span class="pre">Work</span></code> topic to receive the full stream of messages, or do a bookmark
replay over the <code class="docutils literal"><span class="pre">Work</span></code> topic to recreate the message flow or audit the
messages published to that topic.</p>
<p>Also notice that, while the <code class="docutils literal"><span class="pre">Work</span></code> topic (the underlying topic) must be
recorded in the transaction log, there is no need to define the <code class="docutils literal"><span class="pre">Work</span></code> topic
in the SOW section of the configuration file. Queues use the transaction log to
determine which messages to enqueue, and when a message is marked as having
been processed, that fact is also recorded in the transaction log.</p>
<div class="section" id="getting-started-with-amps-queues">
<h2>Getting Started with AMPS Queues<a class="headerlink" href="#getting-started-with-amps-queues" title="Permalink to this headline">Â¶</a></h2>
<p>To add a simple queue to AMPS, add the following options to your
configuration file.</p>
<p>First, create a transaction log that will record the messages for the
queue and the state of the queue, as described in
<a class="reference internal" href="txlog.html#ug-txlog"><span class="std std-ref">Chapter 13 Transactional Messaging and Bookmark Subscriptions</span></a>.
You add the transaction log
entry if your AMPS configuration does not already have one. Otherwise,
you can simply add a <code class="docutils literal"><span class="pre">Topic</span></code> statement or modify an existing <code class="docutils literal"><span class="pre">Topic</span></code>
statement to record the messages. The sample below captures any JSON
messages published to the <code class="docutils literal"><span class="pre">Work</span></code> topic, and also tracks the state of the queue itself:</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;AMPSConfig&gt;</span>
    ...

    <span class="nt">&lt;TransactionLog&gt;</span>
         <span class="nt">&lt;JournalDirectory&gt;</span>./journals<span class="nt">&lt;/JournalDirectory&gt;</span>
         <span class="nt">&lt;Topic&gt;</span>
            <span class="nt">&lt;Name&gt;</span>Work<span class="nt">&lt;/Name&gt;</span>
            <span class="nt">&lt;MessageType&gt;</span>json<span class="nt">&lt;/MessageType&gt;</span>
         <span class="nt">&lt;/Topic&gt;</span>
         <span class="nt">&lt;Topic&gt;</span>
            <span class="nt">&lt;Name&gt;</span>WorkToDo<span class="nt">&lt;/Name&gt;</span>
            <span class="nt">&lt;MessageType&gt;</span>json<span class="nt">&lt;/MessageType&gt;</span>
         <span class="nt">&lt;/Topic&gt;</span>
    <span class="nt">&lt;/TransactionLog&gt;</span>

   ...
<span class="nt">&lt;/AMPSConfig&gt;</span>
</pre></div>
</div>
<p>Next, declare the queue topic itself. Queues are defined in the SOW
element of the <code class="docutils literal"><span class="pre">AMPSConfig</span></code> file, as shown below:</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;AMPSConfig&gt;</span>
    ...

    <span class="nt">&lt;SOW&gt;</span>
        <span class="nt">&lt;Queue&gt;</span>
            <span class="nt">&lt;Name&gt;</span>WorkToDo<span class="nt">&lt;/Name&gt;</span>
            <span class="nt">&lt;MessageType&gt;</span>json<span class="nt">&lt;/MessageType&gt;</span>
            <span class="nt">&lt;Semantics&gt;</span>at-most-once<span class="nt">&lt;/Semantics&gt;</span>
            <span class="nt">&lt;UnderlyingTopic&gt;</span>Work<span class="nt">&lt;/UnderlyingTopic&gt;</span>
        <span class="nt">&lt;/Queue&gt;</span>
    <span class="nt">&lt;/SOW&gt;</span>

    ...
<span class="nt">&lt;/AMPSConfig&gt;</span>
</pre></div>
</div>
<p>These simple configuration changes create an AMPS message queue. Notice
that the <code class="docutils literal"><span class="pre">Topic</span></code> for the queue in this case is <code class="docutils literal"><span class="pre">WorkToDo</span></code>, which
includes every message published to the underlying topic <code class="docutils literal"><span class="pre">Work</span></code>. You
could also use a regular expression to include messages to more than one
topic, or leave out the <code class="docutils literal"><span class="pre">UnderlyingTopic</span></code> to include only messages
published to the topic with the same name as the queue.</p>
<p>This simple queue provides each message that arrives for the queue to at
most one subscriber. After AMPS delivers the message to one subscriber,
AMPS removes the message from the queue without waiting for the
subscriber to acknowledge the message.</p>
<p>While it&#8217;s easy to create a simple queue, AMPS offers a rich queuing
model that is designed to meet a wide variety of queuing needs. The
options are described in the following sections and the <em>AMPS
Configuration Guide</em>.</p>
<p>By default, AMPS queues are <em>distributed queues</em>. That is, if the queue
topic or the underlying topics are replicated, AMPS provides the queue
delivery guarantees as though all of the instances were delivering
messages from a single queue. AMPS also provides local queues (where
each instance has a separate, independent queue) when a queue is defined
with the <code class="docutils literal"><span class="pre">LocalQueue</span></code> tag.</p>
</div>
<div class="section" id="understanding-amps-queuing">
<h2>Understanding AMPS Queuing<a class="headerlink" href="#understanding-amps-queuing" title="Permalink to this headline">Â¶</a></h2>
<p>AMPS message queues take advantage of the full historical and
transactional power of the AMPS engine. Each queue is implemented as a
view over an underlying topic or set of topics. Each of the underlying
topics must be recorded in a transaction log. Publishers publish to the
underlying topic, and the messages are recorded in the transaction log.
Consumers simply subscribe to the queue. AMPS tracks which messages have
been delivered to subscribers and which messages have been processed by
subscribers. AMPS delivers the next available message to the next
subscriber.</p>
<p>Unlike traditional queues, which require consumers to poll for messages,
AMPS queues use a subscription model. In this model, each queue consumer
requests that AMPS provide messages from the queue. The consumer can
also request a maximum number of messages to have outstanding from the
queue at any given time, referred to as the backlog for that consumer.
When a message is available, and the consumer has fewer messages
outstanding than the backlog for that consumer, AMPS delivers the
message to the consumer. This improves latency and conserves bandwidth,
since there is no need for consumers to repeatedly poll the queue to see
if work is available. In addition, the server maintains an overall view
of the consumers, which allows the server to control message
distribution strategies to optimize for latency, optimize to prefer
delivery to clients with the most unused capacity, or optimize for
general fairness.</p>
<p>The following diagram presents a simplified view of an AMPS queue.</p>
<img alt="../_images/AMPS-Queues-Intro.svg" src="../_images/AMPS-Queues-Intro.svg" /><p>As the diagram indicates, a queue tracks a set of messages in the
transaction log. The messages the queue is currently tracking are
considered to be in the queue. When the queue delivers a message, it
marks the message as having been delivered (shown as <em>leased</em> in the
diagram above). Messages that have been processed are no longer tracked
by the queue (for example, the message for the order 1 in the diagram
above). When a message has been delivered and processed, that event is
recorded in the transaction log to ensure that the queue meets the
delivery guarantees even across restarts of AMPS.</p>
<p>Because queues are implemented as views over underlying topics, AMPS
allows you to create any number of queues over the same underlying
topic. Each queue tracks messages to the topic independently, and can
have different policies for delivery and fairness. When a queue topic
has a different name than the underlying topic, you can subscribe to the
underlying topic directly, and that subscription is to the underlying
(non-queue) topic. When a queue topic has the same name as the
underlying topic (the default), all subscriptions to that topic are to
the queue. (Notice that bookmark subscriptions to a queue are pub/sub
subscriptions that replay from the underlying topic in the transaction log,
so the behavior in that case is the same as if the subscription was directly
to the underlying topic.)</p>
<p>Likewise, AMPS queues work seamlessly with the AMPS entitlement system.
Permissions to queues are managed the same way permissions are managed
to any other topic, as described in
<a class="reference internal" href="securing.html#ug-entitlement"><span class="std std-ref">Chapter 26 Entitlement</span></a>
of the <em>AMPS User Guide</em>.</p>
<p>While a message is in a queue, AMPS does not retain an extra copy of the message.
Instead, AMPS retains in memory a small data structure indicating
the state of the message and the position of the message in the transaction log.
The amount of memory consumed by a queue is approximately 200 bytes per message,
regardless of the size of the messages.</p>
<p>AMPS queues provide a variety of options to help you tailor the behavior
of each queue to meet your application&#8217;s needs.</p>
<div class="section" id="delivery-semantics">
<h3>Delivery Semantics<a class="headerlink" href="#delivery-semantics" title="Permalink to this headline">Â¶</a></h3>
<p>AMPS queues deliver a message to a single subscriber at a time. In the
most common case, a queue is delivered to exactly one subscriber, and that
subscriber processes the message.</p>
<p>In case of a failure, where a subscriber does not successfully process
the message, AMPS provides two different delivery semantics to precisely
specify how to handle cases where a subscriber does not successfully
process a message:</p>
<ul>
<li><p class="first">With <code class="docutils literal"><span class="pre">at-least-once</span></code> delivery, AMPS delivers the message to one
subscriber at a time, and expects that subscriber to explicitly
remove the message from the queue when the message has been received
and processed. With this guarantee, each message from the queue must
be processed within a specified timeout, or lease period. AMPS tracks
the amount of time since the message was sent to the subscriber. If
the subscriber has not responded by removing the message within the
lease period, AMPS revokes the lease and the message is available to
another subscriber. AMPS allows you to set limits on the number of
times a message is made available to another subscriber, using the
<code class="docutils literal"><span class="pre">MaxCancels</span></code> and <code class="docutils literal"><span class="pre">MaxDeliveries</span></code> configuration options.</p>
<p>In this model, receiving a message is the equivalent of a
non-destructive get from a traditional queue. To acknowledge and
remove the message, a subscriber uses the <code class="docutils literal"><span class="pre">sow_delete</span></code> command with
the bookmark of the message.</p>
<p>Leases are broken and messages are returned to the queue if the lease
holder disconnects from AMPS. This ensures that, if a message
processor fails or loses its connection to AMPS, the message can
immediately be processed by another message processor.</p>
</li>
<li><p class="first">With <code class="docutils literal"><span class="pre">at-most-once</span></code> delivery, AMPS removes the message from the
queue as soon as the message is sent to a subscriber. However, the
subscriber still needs to acknowledge that the message was processed,
so that AMPS can track the subscription backlog, as described below.</p>
<p>In this model, receiving a message is the equivalent of a destructive
get from a traditional queue. The message is immediately removed by
AMPS, and is no longer available in the queue.</p>
</li>
</ul>
<div class="section" id="choosing-delivery-semantics-to-handle-failures">
<h4>Choosing Delivery Semantics To Handle Failures<a class="headerlink" href="#choosing-delivery-semantics-to-handle-failures" title="Permalink to this headline">Â¶</a></h4>
<p>Regardless of the delivery semantics you choose, during typical message
processing from a queue, AMPS delivers each message in the queue to a single
subscriber, with no duplicates or redelivery.</p>
<p>The difference between <code class="docutils literal"><span class="pre">at-most-once</span></code> and <code class="docutils literal"><span class="pre">at-least-once</span></code> semantics is
important in cases where a failure happens. With <code class="docutils literal"><span class="pre">at-most-once</span></code> delivery,
the message will not be redelivered even if the subscriber fails to process
the message. With <code class="docutils literal"><span class="pre">at-least-once</span></code> delivery, the message will be redelivered
to subscribers until the message is either explicitly acknowledged, explicitly
removed, or expired based on the queue policy for expiration or retries.</p>
<p>With either setting, a message is delivered exactly once, to a single subscriber,
during normal processing.</p>
<p>Consider the following recommendations when deciding how you would like AMPS to
handle cases where the subscriber that receives the message fails to process the
message:</p>
<ol class="arabic simple">
<li>For ephemeral or lower-value data where message loss in the case of failure is
preferable to duplicating message delivery, consider <code class="docutils literal"><span class="pre">at-most-once</span></code> semantics.
For example, processing a stream of events from sensors might fall into this
category: each message should be processed once, in order, during normal operation,
but missing a single data point from time to time may be less disruptive than
reconciling duplicates.</li>
<li>For higher value data where duplicate message delivery in the event of failure is preferable
to message loss, consider <code class="docutils literal"><span class="pre">at-least-once</span></code> semantics. For example, if inserting the same
data into a database twice would simply be an in-place update of the same record with the
same information, having a duplicate insert happen occasionally in the event of failure
may be preferable to losing a message when a failure occurs.</li>
<li>For higher value data where manual intervention is required to reconcile messages
when there is a question as to whether the message has been correctly processed,
consider using <code class="docutils literal"><span class="pre">at-least-once</span></code> message delivery with a <code class="docutils literal"><span class="pre">MaxDeliveries</span></code> setting
and an action to move failed messages to a dead-letter queue for manual reconciliation.</li>
<li>For higher value data that is part of a transactional dataflow where processors
maintain state, it can be useful to include information about the message processed
in the transaction. This can be used with <code class="docutils literal"><span class="pre">at-least-once</span></code> messaging to guarantee that
the message is only processed once: if a processor receives a message that is already
marked as processed in the transactional store, the processor knows that the message
has been already been acted on and should be acknowledged without further processing.
This is the most common pattern used to produce the result that each message is
processed &#8220;exactly once&#8221;. This pattern involves additional overhead and processing,
trading off increased work in the application for stronger guarantees that a message
is only processed one time.</li>
</ol>
</div>
</div>
<div class="section" id="subscription-backlog">
<h3>Subscription Backlog<a class="headerlink" href="#subscription-backlog" title="Permalink to this headline">Â¶</a></h3>
<p>For efficiency, queues in AMPS use a push model of delivery, providing
messages to consumers when the message becomes available rather than
requiring the consumer to poll the queue. To manage the workload among
consumers, AMPS queues keep track of a <em>subscription backlog</em>. This
backlog is the number of messages that have been provided to an
individual subscription that have not yet been acknowledged. This
backlog helps AMPS provide strong delivery guarantees while still
optimizing for high throughput processing. AMPS calculates the
subscription backlog for each subscription by calculating:</p>
<ul>
<li><p class="first">The <em>minimum</em> <code class="docutils literal"><span class="pre">MaxPerSubscriptionBacklog</span></code> setting for the queues
matched by the subscription, <em>or</em></p>
</li>
<li><p class="first">The <code class="docutils literal"><span class="pre">max_backlog</span></code> specified on the subscribe command,</p>
<p>whichever is <em>smallest</em></p>
</li>
</ul>
<p>Notice that, if a subscriber does not provide a <code class="docutils literal"><span class="pre">max_backlog</span></code> on a
subscription, AMPS defaults to a <code class="docutils literal"><span class="pre">max_backlog</span></code> of <code class="docutils literal"><span class="pre">1</span></code>. In practical
terms, this means that an application must explicitly specify a backlog
to be able to receive more than one message from a queue at a time,
regardless of the queue configuration.</p>
<p>Subscribers request a <code class="docutils literal"><span class="pre">max_backlog</span></code> by adding the request to the
options string of the <code class="docutils literal"><span class="pre">subscribe</span></code> command. For example, to request a
<code class="docutils literal"><span class="pre">max_backlog</span></code> of 10, a subscriber includes <code class="docutils literal"><span class="pre">max_backlog=10</span></code> in the
options for the command.</p>
<p>To improve concurrency for subscribers, 60East recommends using a
backlog of at least <code class="docutils literal"><span class="pre">2</span></code>. This allows efficient pipelined delivery, as
the consumer can be processing one message while the previous message is
being acknowledged. With a <code class="docutils literal"><span class="pre">max_backlog</span></code> higher than <code class="docutils literal"><span class="pre">1</span></code>, the
consumer never needs to be stopped waiting for the next message from the
queue.</p>
</div>
<div class="section" id="delivery-fairness">
<h3>Delivery Fairness<a class="headerlink" href="#delivery-fairness" title="Permalink to this headline">Â¶</a></h3>
<p>When a queue provides <code class="docutils literal"><span class="pre">at-least-once</span></code> delivery, AMPS provides three
different algorithms for distributing messages among subscribers. Each
algorithm has different performance and fairness guarantees. For
<code class="docutils literal"><span class="pre">at-most-once</span></code> delivery, AMPS supports only the <code class="docutils literal"><span class="pre">round-robin</span></code> method
of distributing messages.</p>
<table border="1" class="docutils">
<colgroup>
<col width="19%" />
<col width="81%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Algorithm</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">fast</span></code></td>
<td>This strategy optimizes for the lowest latency. AMPS delivers the message to the first
subscription found that does not have a full backlog. With this algorithm, AMPS tries
to minimize the time spent determining which subscription receives the message without
attempting to distribute messages fairly across subscriptions.</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">round-robin</span></code></td>
<td>This strategy optimizes for general fairness across subscriptions. AMPS delivers the
message to the next available subscription that does not have a full backlog. With this
algorithm, AMPS delivers messages evenly among the subscribers that have space in
their backlog.</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">proportional</span></code></td>
<td><p class="first">This strategy optimizes for delivery to subscriptions with the most unused capacity.
AMPS delivers the message to the subscription that has the highest proportion of
backlog capacity unused. AMPS determines this by taking the ratio of unacknowledged
messages to the maximum backlog.</p>
<p>For example, if there are three active subscribers for the queue, with backlog settings
and outstanding messages as follows:</p>
<table border="1" class="docutils">
<colgroup>
<col width="23%" />
<col width="46%" />
<col width="31%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Subscriber</th>
<th class="head">Unacknowledged Messages</th>
<th class="head">Maximum Backlog</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Inky</td>
<td>1</td>
<td>2</td>
</tr>
<tr class="row-odd"><td>Blinky</td>
<td>3</td>
<td>4</td>
</tr>
<tr class="row-even"><td>Clyde</td>
<td>4</td>
<td>10</td>
</tr>
</tbody>
</table>
<p class="last">In this case, with <code class="docutils literal"><span class="pre">proportional</span></code> delivery, a new message for the queue will be
delivered to Clyde, since that subscriber has only filled 40% of the backlog, as
compared with 50% for Inky and 75% for Blinky.</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Table 15.1:</strong> <em>Message Distribution Algorithms</em></p>
<p>AMPS defaults to <code class="docutils literal"><span class="pre">proportional</span></code> delivery for <code class="docutils literal"><span class="pre">at-least-once</span></code> queues
and defaults to <code class="docutils literal"><span class="pre">round-robin</span></code> (the only valid delivery model) for
<code class="docutils literal"><span class="pre">at-most-once</span></code> queues.</p>
</div>
<div class="section" id="priority-queues">
<h3>Priority Queues<a class="headerlink" href="#priority-queues" title="Permalink to this headline">Â¶</a></h3>
<p>AMPS includes the ability to specify that messages from a queue are delivered
in order of <em>priority</em> rather than being delivered strictly in publication order.
To enable prioritization on a <code class="docutils literal"><span class="pre">Queue</span></code>, add the <code class="docutils literal"><span class="pre">Priority</span></code> tag to the queue
configuration and specify the field or expression to use to set the priority.
When a queue definition specifies <code class="docutils literal"><span class="pre">Priority</span></code>, AMPS orders delivery based on
a descending sort of the value calculated for the <code class="docutils literal"><span class="pre">Priority</span></code> rather than
in descending order of age.</p>
<p>Priority expressions use the same grammar as other expressions in AMPS, as
as described in <a class="reference internal" href="amps_expressions.html#ug-amps-expressions"><span class="std std-ref">4. AMPS Expressions</span></a>. The results of the priority
expression are interpreted as an <code class="docutils literal"><span class="pre">unsigned</span> <span class="pre">long</span></code>. That is, the result should
be a positive integer that can be represented in 64 bits. Non-numeric values
or <code class="docutils literal"><span class="pre">NULL</span></code> are treated as <code class="docutils literal"><span class="pre">NaN</span></code>, and have the lowest priority.</p>
<p>For example, to create a queue that delivers messages in order of the product of
the price and quantity specified in the message, you could use the following
queue definition:</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;AMPSConfig&gt;</span>
    ...
    <span class="c">&lt;!-- Other configuration, including</span>
<span class="c">         recording  that OrderPriority</span>
<span class="c">         and Orders are recorded in the</span>
<span class="c">         transaction log.</span>
<span class="c">      --&gt;</span>

    <span class="nt">&lt;SOW&gt;</span>
        ...
        <span class="nt">&lt;Queue&gt;</span>
            <span class="nt">&lt;Name&gt;</span>OrderPriority<span class="nt">&lt;/Name&gt;</span>
            <span class="nt">&lt;MessageType&gt;</span>json<span class="nt">&lt;/MessageType&gt;</span>
            <span class="nt">&lt;Semantics&gt;</span>at-least-once<span class="nt">&lt;/Semantics&gt;</span>
            <span class="nt">&lt;UnderlyingTopic&gt;</span>Orders<span class="nt">&lt;/UnderlyingTopic&gt;</span>
            <span class="nt">&lt;Priority&gt;</span>/price * /qty<span class="nt">&lt;/Priority&gt;</span>
        <span class="nt">&lt;/Queue&gt;</span>
    <span class="nt">&lt;/SOW&gt;</span>

    ...
<span class="nt">&lt;/AMPSConfig&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="acknowledging-messages">
<h3>Acknowledging Messages<a class="headerlink" href="#acknowledging-messages" title="Permalink to this headline">Â¶</a></h3>
<p>Subscribers must acknowledge each message to indicate to AMPS that a
message has been processed. The point at which a subscriber acknowledges
a message depends on the exact processing that the subscriber performs
and the processing guarantees for the application. In general,
applications acknowledge messages at the point at which the processing
has a result that is durable and which would require an explicit action
(such as another message) to change. Some common points at which to
acknowledge a message are:</p>
<ul class="simple">
<li>When processing is fully completed</li>
<li>When work is performed that would require a compensating action (that
is, when information is committed to a database or forwarded to a
downstream system)</li>
<li>When work is submitted to a processor that is guaranteed to either
succeed or explicitly indicate failure</li>
</ul>
<p>To acknowledge a message, the subscriber typically uses the acknowledge
convenience methods in the AMPS client. These commands issue a
<code class="docutils literal"><span class="pre">sow_delete</span></code> command with the bookmark from the message to
acknowledge. AMPS allows subscribers to acknowledge multiple messages
simultaneously by providing a comma-delimited list of bookmarks in the
<code class="docutils literal"><span class="pre">sow_delete</span></code> command: the AMPS clients provide facilities to batch
acknowledgments for efficiency.</p>
<p>AMPS allows an application to acknowledge messages by providing a filter on a
<code class="docutils literal"><span class="pre">sow_delete</span></code> command. In this case, the <code class="docutils literal"><span class="pre">sow_delete</span></code> acknowledges all
messages that match the filter, regardless of whether the application that
sends the command has a current lease on a given message or not. (The
<code class="docutils literal"><span class="pre">Leasing</span></code> parameter on the queue specifies whether AMPS allows a client to
successfully acknowledge messages that it does not have currently leased.)</p>
<p>For queues that use the <code class="docutils literal"><span class="pre">at-least-once</span></code> delivery model, there are two
additional options available for acknowledging messages.</p>
<ul class="simple">
<li><strong>To return a message to the queue without processing it</strong>, the
subscriber provides the <code class="docutils literal"><span class="pre">cancel</span></code> option on the acknowledgement.
In this case, AMPS returns the message to the queue just as though
the lease had expired. If the message is eligible for redelivery
(that is, it has not exceeded the maximum time or maximum cancels
configured for the queue), it is redelivered. Otherwise, the
message is expired from the queue. The <code class="docutils literal"><span class="pre">MaxCancels</span></code> option
allows you to configure how many times a message can be returned
to the queue for redelivery before AMPS expires the message.</li>
<li><strong>To immediately remove a message from the queue</strong>, the subscriber
provides the <code class="docutils literal"><span class="pre">expire</span></code> option. In this case, AMPS does not return
the message to the queue for redelivery, but instead immediately
expires the message from the queue and triggers any configured
<code class="docutils literal"><span class="pre">amps-action-on-sow-expire-message</span></code> actions that monitor the
queue. The <code class="docutils literal"><span class="pre">expire</span></code> option can be especially helpful if your
application can determine that the message cannot be successfully
processed (for example, the message is unparseable or contains
invalid data).</li>
</ul>
<p>Options for acknowledging messages delivered from <code class="docutils literal"><span class="pre">at-least-once</span></code> queues:</p>
<table border="1" class="docutils">
<colgroup>
<col width="18%" />
<col width="82%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><strong>option</strong></td>
<td><strong>result</strong></td>
</tr>
<tr class="row-even"><td>&lt;none&gt;</td>
<td>Message is considered to be successfully processed
and removed from the queue.</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">cancel</span></code></td>
<td>Message is returned to the queue. The count of cancels
for this message is incremented, and if the count
is greater than the configured <code class="docutils literal"><span class="pre">MaxCancels</span></code> for the
queue, the message is expired.</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">expire</span></code></td>
<td>Message is immediately expired from the queue.</td>
</tr>
</tbody>
</table>
<p>For <code class="docutils literal"><span class="pre">at-most-once</span></code> queues, these options to acknowledgements have no effect,
since the message is guaranteed not to be redelivered even if processing fails.</p>
</div>
<div class="section" id="message-flow-for-queues">
<h3>Message Flow for Queues<a class="headerlink" href="#message-flow-for-queues" title="Permalink to this headline">Â¶</a></h3>
<p>The message flow for AMPS queues is as follows. The message flow differs
depending on whether the queue is configured for <code class="docutils literal"><span class="pre">at-most-once</span></code>
delivery or <code class="docutils literal"><span class="pre">at-least-once</span></code> delivery.</p>
<p>When the queue is configured for <code class="docutils literal"><span class="pre">at-most-once</span></code> delivery:</p>
<ol class="arabic">
<li><p class="first">A publisher publishes a message to an underlying topic.</p>
</li>
<li><p class="first">The message becomes available in the queue.</p>
</li>
<li><p class="first">The message is published to a subscriber when:</p>
<ul class="simple">
<li>There is a subscription that matches the message, and the
subscriber is entitled to see the message</li>
<li>The message is the oldest message in the queue that matches the
subscription (if no <code class="docutils literal"><span class="pre">Priority</span></code> is specified for the queue) or
it has the highest priority value for messages in the queue
and is the oldest message at that priority (if <code class="docutils literal"><span class="pre">Priority</span></code>
is specified).</li>
<li>The subscription has remaining capacity in its backlog</li>
<li>The subscription is the next subscription to receive the message
as determined by the delivery fairness for the queue</li>
</ul>
<p>AMPS removes the message from the queue when the message is
published.</p>
</li>
<li><p class="first">If no subscription has requested the message, and the message has
been in the queue longer than the <code class="docutils literal"><span class="pre">Expiration</span></code> time, AMPS removes
the message from the queue. With AMPS queues, message expiration is
considered to be a normal way for the message to leave the queue, and
is not considered an error.</p>
</li>
<li><p class="first">The subscriber processes the message, and acknowledges the message
when processing is finished to indicate to AMPS that the subscriber
has capacity for another message.</p>
</li>
</ol>
<p>When the queue is configured for <code class="docutils literal"><span class="pre">at-least-once</span></code> delivery:</p>
<ol class="arabic">
<li><p class="first">A publisher publishes a message to an underlying topic.</p>
</li>
<li><p class="first">The message becomes available in the queue.</p>
</li>
<li><p class="first">The message is published to a subscriber when:</p>
<ul class="simple">
<li>There is a subscription that matches the message</li>
<li>The message is the oldest message in the queue that matches the
subscription (if no <code class="docutils literal"><span class="pre">Priority</span></code> is specified for the queue) or
it has the highest priority value for messages in the queue
and is the oldest message at that priority (if <code class="docutils literal"><span class="pre">Priority</span></code>
is specified).</li>
<li>The subscription has remaining capacity in its backlog</li>
<li>The subscription is the next subscription to receive a message as
determined by the delivery fairness for the queue</li>
</ul>
<p>AMPS calculates the lease time for the message and provides that time
to the subscriber along with the message.</p>
</li>
<li><p class="first">If the message has been in the queue longer than the <code class="docutils literal"><span class="pre">Expiration</span></code>
time, and there is no current lease on the message, AMPS removes the
message from the queue.</p>
</li>
<li><p class="first">If a subscriber has received the message, but has not removed the
message from the queue at the time the lease expires, AMPS returns
the message to the queue if the message has been in the queue less
than the <code class="docutils literal"><span class="pre">Expiration</span></code> time, and it has been delivered fewer than
the <code class="docutils literal"><span class="pre">MaxDeliveries</span></code> limit. If the message has been in the queue
longer than the <code class="docutils literal"><span class="pre">Expiration</span></code> time or has been delivered more than
the number of times specified by <code class="docutils literal"><span class="pre">MaxDeliveries</span></code>, AMPS removes the
message from the queue when the lease expires.</p>
</li>
<li><p class="first">The subscriber processes the message, and removes the message from
the queue by acknowledging the message (which is translated by the
client into the appropriate <code class="docutils literal"><span class="pre">sow_delete</span></code> command).</p>
</li>
</ol>
</div>
<div class="section" id="advanced-messaging-and-queues">
<h3>Advanced Messaging and Queues<a class="headerlink" href="#advanced-messaging-and-queues" title="Permalink to this headline">Â¶</a></h3>
<p>Queues are implemented as AMPS topics which lets you use the advanced
messaging features of AMPS to create your queues and provide insight
into your queues. For example, consumers can use content filtering to
select the messages from the queue that they want to consume. You can
use content filters to select only a subset of messages published to an
underlying topic to populate the queue. You can even create a view that
aggregates data from multiple topics, and use that view as the
underlying topic for the queue. Since messages for queues are recorded
in the transaction log, you can easily replay the messages that the
queue provided to subscribers by using a bookmark subscription.</p>
<div class="section" id="querying-queues-as-a-view">
<h4>Querying Queues as a View<a class="headerlink" href="#querying-queues-as-a-view" title="Permalink to this headline">Â¶</a></h4>
<p>For each queue, AMPS provides a view of the currently available
messages. Applications can query this queue just as though it were a
view. For example, if you have a queue named <code class="docutils literal"><span class="pre">PendingOrders</span></code>, you can
see the currently available messages in the queue by querying the queue
as though it were a view, with a <code class="docutils literal"><span class="pre">sow</span></code> command.</p>
<p>A query of a queue is <em>read-only</em>. AMPS does not lease the returned
messages to the querying application, or remove them from the queue.</p>
</div>
<div class="section" id="topic-in-the-state-of-the-world-as-an-underlying-topic-for-a-queue">
<span id="ug-sow-underlying-queue"></span><h4>Topic in the State of the World as an Underlying Topic for a Queue<a class="headerlink" href="#topic-in-the-state-of-the-world-as-an-underlying-topic-for-a-queue" title="Permalink to this headline">Â¶</a></h4>
<p>AMPS fully supports a topic that maintains a SOW as an underlying topic
for a queue. Since a queue records every individual publish to a topic
(rather than simply preserving the current state of a distinct message
identified by a SOW key), each publish to the SOW topic creates a new
message in the queue.</p>
<p>AMPS does not provide Out-of-Focus messages to the queue. Only publish
messages are added to the queue.</p>
<p>Deleting a message from an underlying topic that maintains a SOW does
not remove the corresponding messages from the queue. Likewise, when a
message expires from the SOW, it is not removed from the queue.</p>
<p>When a message is published to a topic in the SOW, and that topic uses
expiration, the message is stamped with the expiration value
set for the topic before being written to the transaction log.
This means that the message will have the same expiration in the queue.</p>
</div>
<div class="section" id="delta-messaging-with-queues">
<h4>Delta Messaging with Queues<a class="headerlink" href="#delta-messaging-with-queues" title="Permalink to this headline">Â¶</a></h4>
<p>AMPS delta subscriptions rely on being able to determine the last state
of a message delivered on a subscription and providing a set of changes
to the subscriber. With AMPS queues, AMPS treats each update to a SOW
record as a new message, so there&#8217;s no previous state that would
generate a delta message. When an underlying topic of a queue is a SOW
topic, AMPS supports delta publish to that underlying topic. The full,
merged message is added to the queue.</p>
<p>AMPS allows delta subscriptions to a queue, but treats each message as a
new publish and delivers the full message.</p>
</div>
<div class="section" id="views-and-aggregated-subscriptions-over-queues">
<h4>Views and Aggregated Subscriptions over Queues<a class="headerlink" href="#views-and-aggregated-subscriptions-over-queues" title="Permalink to this headline">Â¶</a></h4>
<p>AMPS fully supports creating a view or an aggregated subscription with a
queue as an underlying topic. In both cases, AMPS operates on the
messages that are currently available in the queue. When a message is
leased, that message is no longer available to the queue and does not
appear in the view or the aggregated subscription. If the message is
returned to the queue, then the message is again available to the view
or aggregated subscription. When a message expires, that message is no
longer available in the view or aggregated subscription.</p>
<p>Views and aggregated subscriptions are considered to be query of the
queue, so they are <em>read-only</em>. Views and aggregated subscriptions do
not lease messages from the queue and do not affect message delivery.</p>
<p>Views over queues can be useful to show constantly-updated aggregates of
the activity in the queue. For example, you could create an aggregate
that shows the total value of unprocessed orders currently in the queue.</p>
</div>
<div class="section" id="bookmark-subscriptions-to-queues">
<h4>Bookmark Subscriptions to Queues<a class="headerlink" href="#bookmark-subscriptions-to-queues" title="Permalink to this headline">Â¶</a></h4>
<p>A queue itself supports <cite>at_most_once</cite> or <cite>at_least_once</cite> delivery.
It does not provide a way to replay messages once a subscriber
has acknowledged the message.</p>
<p>To support replay of messages from a queue, AMPS translates a
bookmark subscription to a queue to be a bookmark subscription
to the underlying topic for the queue. This allows you to replay
messages from the underlying topic <em>without</em> queue delivery semantics.
That is, a bookmark subscription to a queue becomes a
publish/subscribe bookmark subscription to the underlying topic,
<em>not</em> a subscription to the queue.  Messages from this subscription do
not have <code class="docutils literal"><span class="pre">at-most-once</span></code> or <code class="docutils literal"><span class="pre">at-least-once</span></code> delivery, and do not need
to be acknowledged. The subscription is a publish/subscribe bookmark
subscription, just as though there was no queue for the topic.</p>
<p>To get queuing semantics, do not include a bookmark on subscriptions to
a queue.</p>
</div>
</div>
</div>
<div class="section" id="replacing-queue-subscriptions">
<h2>Replacing Queue Subscriptions<a class="headerlink" href="#replacing-queue-subscriptions" title="Permalink to this headline">Â¶</a></h2>
<p>Queues support the <code class="docutils literal"><span class="pre">replace</span></code> option for subscriptions. As with
subscriptions to other topics, queue subscriptions can replace the
content filter, the topic, the options, or all of the above. Replacement
is atomic. The queue consumer is guaranteed that, after the replace
occurs, only messages that match the new subscription will be delivered.</p>
<p>Replacing queue subscriptions differs from unsubscribing and
resubscribing with new parameters in two ways:</p>
<ol class="arabic">
<li><p class="first">AMPS does not break message leases or adjust the number of
currently-unacknowledged messages for the subscription, even if the
messages no longer match the current subscription. AMPS makes no
assumptions about the state of the messages, and requires the
subscriber to acknowledge them or allow the lease to expire.</p>
</li>
<li><p class="first">AMPS may change the maximum backlog for the subscription if either
the <code class="docutils literal"><span class="pre">max_backlog</span></code> option <em>or</em> the topic for the subscription has
changed. AMPS adjusts the backlog using the same logic as when the
subscription was entered: the maximum backlog will be the smaller of
the option set by the consumer or the limit on the queue. This can
result in a situation where the consumer has more messages leased
than the current maximum for the subscription, and no new messages
will be delivered until that number drops below the current maximum.</p>
<p>For example, if the consumer has a requested <code class="docutils literal"><span class="pre">max_backlog</span></code> of 10 and
updates a subscription from a queue with a configured maximum of 10
to a queue with a configured maximum of 5, the new backlog for the
subscription will be 5. However, the consumer may still have 10
messages outstanding.</p>
</li>
</ol>
<p>In all other ways, AMPS behaves as though the replaced subscription was
a new subscription to the queue.</p>
<div class="section" id="handling-unprocessed-messages">
<span id="index-1"></span><h3>Handling Unprocessed Messages<a class="headerlink" href="#handling-unprocessed-messages" title="Permalink to this headline">Â¶</a></h3>
<p>Queuing applications occasionally encounter data that cannot be successfully
processed or completed. AMPS allows you to configure actions that occur when
a message expires from a message queue. You can create a dead-letter queue or
topic by using the <code class="docutils literal"><span class="pre">amps-action-on-sow-expire-message</span></code> action in conjunction
with the <code class="docutils literal"><span class="pre">MaxCancels</span></code> option, <code class="docutils literal"><span class="pre">MaxDeliveries</span></code> option, and the <code class="docutils literal"><span class="pre">cancel</span></code>
and <code class="docutils literal"><span class="pre">expire</span></code> options on the <code class="docutils literal"><span class="pre">sow_delete</span></code> command.</p>
<p>As an example, suppose your queue <code class="docutils literal"><span class="pre">Jobs</span></code> is used to coordinate computation
jobs, and in the rare case where a job cannot be completed successfully, you
would like AMPS to automatically move the job to another queue, <code class="docutils literal"><span class="pre">FailedJobs</span></code>.
AMPS provides <code class="docutils literal"><span class="pre">MaxCancels</span></code> and <code class="docutils literal"><span class="pre">MaxDeliveries</span></code> options to specify how many
attempts it should make to deliver a message to a subscriber:</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;AMPSConfig&gt;</span>
    ...

    <span class="nt">&lt;SOW&gt;</span>
        <span class="nt">&lt;Queue&gt;</span>
            <span class="nt">&lt;Name&gt;</span>Jobs<span class="nt">&lt;/Name&gt;</span>
            <span class="nt">&lt;MessageType&gt;</span>json<span class="nt">&lt;/MessageType&gt;</span>
            <span class="nt">&lt;MaxCancels&gt;</span>3<span class="nt">&lt;/MaxCancels&gt;</span>
            <span class="nt">&lt;MaxDeliveries&gt;</span>10<span class="nt">&lt;/MaxDeliveries&gt;</span>
        <span class="nt">&lt;/Queue&gt;</span>
        <span class="nt">&lt;Queue&gt;</span>
            <span class="nt">&lt;Name&gt;</span>FailedJobs<span class="nt">&lt;/Name&gt;</span>
            <span class="nt">&lt;MessageType&gt;</span>json<span class="nt">&lt;/MessageType&gt;</span>
        <span class="nt">&lt;/Queue&gt;</span>
    <span class="nt">&lt;/SOW&gt;</span>
<span class="nt">&lt;/AMPSConfig&gt;</span>
</pre></div>
</div>
<p>In this configuration, AMPS will automatically expire a message from <code class="docutils literal"><span class="pre">Jobs</span></code>
on the 3rd time it receives a <code class="docutils literal"><span class="pre">sow_delete</span></code> with the <code class="docutils literal"><span class="pre">cancel</span></code> operation
for that message, or after the 10th unsuccessful delivery of the message.
By default, expiring a message simply means the message is removed from the
queue, but in this case, we also want the <code class="docutils literal"><span class="pre">FailedJobs</span></code> queue to receive
the message so that it can be manually reviewed later. To accomplish this,
AMPS provides the <code class="docutils literal"><span class="pre">amps-action-on-sow-expire-message</span></code> action which can be
configured to do so:</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;AMPSConfig&gt;</span>
    ...
    <span class="nt">&lt;Actions&gt;</span>
        <span class="nt">&lt;Action&gt;</span>
            <span class="nt">&lt;On&gt;</span>
                <span class="nt">&lt;Module&gt;</span>amps-action-on-sow-expire-message<span class="nt">&lt;/Module&gt;</span>
                <span class="nt">&lt;Options&gt;</span>
                    <span class="nt">&lt;Topic&gt;</span>Jobs<span class="nt">&lt;/Topic&gt;</span>
                    <span class="nt">&lt;MessageType&gt;</span>json<span class="nt">&lt;/MessageType&gt;</span>
                <span class="nt">&lt;/Options&gt;</span>
            <span class="nt">&lt;/On&gt;</span>
            <span class="nt">&lt;Do&gt;</span>
                <span class="nt">&lt;Module&gt;</span>amps-action-do-publish-message<span class="nt">&lt;/Module&gt;</span>
                <span class="nt">&lt;Options&gt;</span>
                    <span class="nt">&lt;Topic&gt;</span>FailedJobs<span class="nt">&lt;/Topic&gt;</span>
                    <span class="nt">&lt;MessageType&gt;</span>json<span class="nt">&lt;/MessageType&gt;</span>
                    <span class="nt">&lt;Data&gt;</span>{ &quot;message&quot;: {{AMPS_DATA}}, &quot;reason&quot;: &quot;{{AMPS_REASON}}&quot; }<span class="nt">&lt;/Data&gt;</span>
                <span class="nt">&lt;/Options&gt;</span>
            <span class="nt">&lt;/Do&gt;</span>
        <span class="nt">&lt;/Action&gt;</span>
    <span class="nt">&lt;/Actions&gt;</span>
    ...
<span class="nt">&lt;/AMPSConfig&gt;</span>
</pre></div>
</div>
<p>With this action configured, any expired message from <code class="docutils literal"><span class="pre">Jobs</span></code> will result in a
message automatically published to <code class="docutils literal"><span class="pre">FailedJobs</span></code> containing the original
message inside the <code class="docutils literal"><span class="pre">message</span></code> element, and an AMPS-supplied reason code in
the <code class="docutils literal"><span class="pre">reason</span></code> field.</p>
</div>
<div class="section" id="using-multiple-underlying-topics">
<h3>Using Multiple Underlying Topics<a class="headerlink" href="#using-multiple-underlying-topics" title="Permalink to this headline">Â¶</a></h3>
<p>AMPS queues can contain messages from any number of underlying topics. This provides
a flexible delivery model, and allows applications to populate multiple queues
with a single publish to AMPS, which simplifies publisher code, reduces bandwidth,
and ensures that the message is provided to all queues from the same point in
the message stream.</p>
<p>To create a queue that includes messages from underlying topics, you provide a
regular expression that matches the set of topic names that contain messages for
the queue.  You also provide a <code class="docutils literal"><span class="pre">DefaultPublishTarget</span></code> that specifies the topic
name for AMPS to use when a message is published directly to the queue topic.</p>
<p>For example, you might configure a set of topics as follows:</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;SOW&gt;</span>
  ...
  <span class="nt">&lt;Queue&gt;</span>
     <span class="nt">&lt;Name&gt;</span>ORDERS_ANALYTICS<span class="nt">&lt;/Name&gt;</span>
     <span class="nt">&lt;MessageType&gt;</span>json<span class="nt">&lt;/MessageType&gt;</span>
     <span class="nt">&lt;UnderlyingTopic&gt;</span>^ORDERS$|^ORDERS_ANALYTICS_DIRECT$<span class="nt">&lt;/UnderlyingTopic&gt;</span>
     <span class="nt">&lt;DefaultPublishTarget&gt;</span>ORDERS_ANALYTICS_DIRECT<span class="nt">&lt;/DefaultPublishTarget&gt;</span>
  <span class="nt">&lt;/Queue&gt;</span>
  <span class="nt">&lt;Queue&gt;</span>
     <span class="nt">&lt;Name&gt;</span>ORDERS_RISK<span class="nt">&lt;/Name&gt;</span>
     <span class="nt">&lt;MessageType&gt;</span>json<span class="nt">&lt;/MessageType&gt;</span>
     <span class="nt">&lt;UnderlyingTopic&gt;</span>^ORDERS$|^ORDERS_RISK_DIRECT$<span class="nt">&lt;/UnderlyingTopic&gt;</span>
     <span class="nt">&lt;DefaultPublishTarget&gt;</span>ORDERS_RISK_DIRECT<span class="nt">&lt;/DefaultPublishTarget&gt;</span>
  <span class="nt">&lt;/Queue&gt;</span>
  ...
<span class="nt">&lt;/SOW&gt;</span>
</pre></div>
</div>
<p>In this case, when a message is published to the <code class="docutils literal"><span class="pre">ORDERS</span></code> topic, both the
<code class="docutils literal"><span class="pre">ORDERS_ANALYTICS</span></code> and the <code class="docutils literal"><span class="pre">ORDERS_RISK</span></code> queues deliver the message.
However, a publisher can also publish directly to each queue by publishing
a message to the <code class="docutils literal"><span class="pre">_DIRECT</span></code> topic for that queue. Furthermore, any publish
to the name of the queue will be routed to the appropriate <code class="docutils literal"><span class="pre">_DIRECT</span></code> topic.</p>
<p>The following table demonstrates how messages are provided to topics with
this configuration:</p>
<table border="1" class="docutils">
<colgroup>
<col width="31%" />
<col width="69%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Publish To</th>
<th class="head">Results</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">ORDERS</span></code></td>
<td>Both <code class="docutils literal"><span class="pre">ORDERS_ANALYTICS</span></code> and <code class="docutils literal"><span class="pre">ORDERS_RISK</span></code> enqueue the
message, since <code class="docutils literal"><span class="pre">ORDERS</span></code> matches the <code class="docutils literal"><span class="pre">UnderlyingTopic</span></code> of
both queues.</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">ORDERS_ANALYTICS</span></code></td>
<td>The message is published to the <code class="docutils literal"><span class="pre">DefaultPublishTarget</span></code>
of <code class="docutils literal"><span class="pre">ORDERS_ANALYTICS</span></code>, which is <code class="docutils literal"><span class="pre">ORDERS_ANALYTICS_DIRECT</span></code>.
The message is then enqueued to <code class="docutils literal"><span class="pre">ORDERS_ANALYTICS</span></code>, since
<code class="docutils literal"><span class="pre">ORDERS_ANALYTICS_DIRECT</span></code> matches the <code class="docutils literal"><span class="pre">UnderlyingTopic</span></code> of
<code class="docutils literal"><span class="pre">ORDERS_ANALYTICS</span></code>.</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">ORDERS_RISK</span></code></td>
<td>The message is published to the <code class="docutils literal"><span class="pre">DefaultPublishTarget</span></code>
of <code class="docutils literal"><span class="pre">ORDERS_RISK</span></code>, which is <code class="docutils literal"><span class="pre">ORDERS_RISK_DIRECT</span></code>.
The message is then enqueued to <code class="docutils literal"><span class="pre">ORDERS_RISK</span></code>, since
<code class="docutils literal"><span class="pre">ORDERS_RISK_DIRECT</span></code> matches the <code class="docutils literal"><span class="pre">UnderlyingTopic</span></code>
<code class="docutils literal"><span class="pre">ORDERS_RISK</span></code>.</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">ORDERS_ANALYTICS_DIRECT</span></code></td>
<td>The message is published to <code class="docutils literal"><span class="pre">ORDERS_ANALYTICS_DIRECT</span></code>,
and is then enqueued to <code class="docutils literal"><span class="pre">ORDERS_ANALYTICS</span></code>.</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">ORDERS_RISK_DIRECT</span></code></td>
<td>The message is published to <code class="docutils literal"><span class="pre">ORDERS_RISK_DIRECT</span></code>, and is
then enqueued to <code class="docutils literal"><span class="pre">ORDERS_RISK</span></code>.</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="queue-subscriptions-compared-to-bookmark-replays">
<h2>Queue Subscriptions Compared to Bookmark Replays<a class="headerlink" href="#queue-subscriptions-compared-to-bookmark-replays" title="Permalink to this headline">Â¶</a></h2>
<p>At first glance, a subscription to a queue can look very similar to a bookmark
replay. In both caes, messages are provided in order from the transaction log.
In both cases, a message that is not processed can be retrieved and redelivered.
In both cases, AMPS allows a subscription to exactly specify the
messages of interest using content filtering.</p>
<p>There are a few main differences:</p>
<ul>
<li><p class="first">Delivery Model</p>
<p>With a bookmark subscription, a message from a given topic can be delivered
to any number of subscribers and processed multiple times. A given
subscriber can replay the same messages any number of times, if needed.</p>
<p>With a queue subscription, the server guarantees that once a message
is processed, it is not delivered from that topic again.</p>
</li>
<li><p class="first">Delivery Limits</p>
<p>With a bookmark subscription, by default AMPS will deliver messages to the
subscription as fast as the physical hardware, disk, and network
allow.</p>
<p>To help ensure that messages are processed in a timely manner, with a
queue subscription AMPS intentionally limits the number of messages
delivered to a subscriber. Since each message should be delivered only
once, delivering every message to a single subscriber would run the
risk of having a slow consumer holding messages that it is unable
to process, while a faster consumer sits idle.</p>
</li>
</ul>
<ul>
<li><p class="first">Acknowledgement</p>
<p>With a bookmark subscription, the application and client libraries are
responsible for tracking which messages have been processed and providing
the correct recovery point. There is no state stored in the AMPS server
as to which messages have been consumed by a given subscription.</p>
<p>With a queue subscription, the AMPS server tracks whether a given message
has been processed. A queue subscriber must notify the server that it
is finished with a given message and is ready for more work. The AMPS
client libraries contain support for making this process easy, as well
as the ability to batch acknowledgements to provide high throughput
while maintaining efficient processing and the guarantees for queues.</p>
</li>
</ul>
</div>
<div class="section" id="sow-queue-and-sow-localqueue">
<span id="index-2"></span><h2>SOW/Queue and SOW/LocalQueue<a class="headerlink" href="#sow-queue-and-sow-localqueue" title="Permalink to this headline">Â¶</a></h2>
<p id="index-3">This section lists configuration parameters for queues.</p>
<p>The <code class="docutils literal"><span class="pre">Queue</span></code> tag and the <code class="docutils literal"><span class="pre">LocalQueue</span></code> tag are used to configure
message queues.</p>
<p>When an AMPS queue is defined with the <code class="docutils literal"><span class="pre">Queue</span></code> tag, the queue will be
a distributed queue. To make a queue that is limited to the local
instance, use the <code class="docutils literal"><span class="pre">LocalQueue</span></code> configuration element</p>
<p>AMPS accepts <code class="docutils literal"><span class="pre">QueueDefinition</span></code> as a synonym for <code class="docutils literal"><span class="pre">Queue</span></code>.</p>
<table border="1" class="docutils">
<colgroup>
<col width="30%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><strong>Element</strong></th>
<th class="head"><strong>Description</strong></th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last highlight-default"><div class="highlight"><pre><span></span><span class="n">Name</span>
</pre></div>
</div>
</td>
<td><p class="first">The name of the queue topic. This name is the name that consumers
subscribe to.</p>
<p class="last">If no <code class="docutils literal"><span class="pre">Name</span></code> is provided, AMPS accepts <code class="docutils literal"><span class="pre">Topic</span></code> as a synonym for
<code class="docutils literal"><span class="pre">Name</span></code> in the <code class="docutils literal"><span class="pre">Queue</span></code> definition.</p>
</td>
</tr>
<tr class="row-odd"><td><div class="first last highlight-default"><div class="highlight"><pre><span></span><span class="n">MessageType</span>
</pre></div>
</div>
</td>
<td>The message type of the queue.</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">UnderlyingTopic</span></code></td>
<td><p class="first">A topic name or regular expression for the topic that contains the
messages to capture in the queue. These topics must be recorded in a
transaction log, and all must be of the same message type as the queue.</p>
<p class="last">If an <code class="docutils literal"><span class="pre">UnderlyingTopic</span></code> is not provided, the <code class="docutils literal"><span class="pre">UnderlyingTopic</span></code>
defaults to the <code class="docutils literal"><span class="pre">Name</span></code> of the queue.</p>
</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">DefaultPublishTarget</span></code></td>
<td><p class="first">The topic to publish to when an application publishes a message to
the queue. For simplicity, AMPS allows applications to publish
messages to the queue, and for those messages to be routed to one of the
underlying topics.</p>
<p class="last">This element is required if the <code class="docutils literal"><span class="pre">UnderlyingTopic</span></code> contains regular
expression characters. Otherwise, the <code class="docutils literal"><span class="pre">UnderlyingTopic</span></code> is a single
topic and this element is optional and defaults to the
<code class="docutils literal"><span class="pre">UnderlyingTopic</span></code>.</p>
</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">LeasePeriod</span></code></td>
<td><p class="first">The amount of time that a subscriber has ownership of the message before
the message is returned to the queue. For <code class="docutils literal"><span class="pre">at-least-once</span></code> delivery
semantics, the consumer must process and acknowledge the message within
this lease period, or the message may be provided to another subscriber.</p>
<p>The <code class="docutils literal"><span class="pre">LeasePeriod</span></code> is measured from the time that AMPS sends the
message to the subscriber. Set the <code class="docutils literal"><span class="pre">LeasePeriod</span></code> to account for round
trip network latency as well as the expected processing time for the
subscribers.</p>
<p class="last">Default: <code class="docutils literal"><span class="pre">infinite</span></code> (no expiration)</p>
</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">Semantics</span></code></td>
<td><p class="first">The delivery semantics to use for this queue. Regardless of the delivery
semantics, AMPS queues deliver a given message to a single subscriber
at a time. When a subscriber fails to process a message, the delivery
semantics specify how that failure should be handled.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">at-least-once</span></code> With these semantics, you can guarantee that a
message has been processed by at least one subscriber, as described
in the introduction to Queues in the <em>AMPS User Guide</em>. With this
value, a subscriber must explicitly remove the message from the queue
once the message is processed. If the subscriber fails before
acknowledging the message, returns the message to the queue, or
the lease expires, the AMPS server can deliver the message again to
allow another attempt to process the message.</li>
<li><code class="docutils literal"><span class="pre">at-most-once</span></code> With these semantics, AMPS removes the message from
the queue immediately when AMPS sends the message. This allows you to
guarantee that no more than one subscriber will process the message,
even if the subscriber that receives the message fails without
acknowledging the message.</li>
</ul>
<p class="last">Default: <code class="docutils literal"><span class="pre">at-least-once</span></code></p>
</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">MaxBacklog</span></code></td>
<td><p class="first">The maximum number of outstanding, unacknowledged messages in the queue
at any one time. This parameter allows you to set limits on the
number of pending messages from the queue overall. When the queue
reaches the MaxBacklog, no incoming messages are delivered from the
queue until a message is removed from the queue (either by expiring, or
being acknowledged by a client). This parameter allows you to avoid
overwhelming clients during periods of heavy activity.</p>
<p>Notice that this does not set a limit of any sort on the capacity of the
queue. This parameter allows you to limit the number of messages that
the queue will make available to subscribers at a given time, but does
not restrict the capacity of the queue to track messages.</p>
<p class="last">Default: <code class="docutils literal"><span class="pre">infinite</span></code></p>
</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">MaxPerSubscriptionBacklog</span></code></td>
<td><p class="first">The maximum number of outstanding, unacknowledged messages in the queue
for an individual subscription. This parameter allows you to avoid
overwhelming a single subscriber during a period of heavy activity.</p>
<p>Subscribers can declare the maximum number of messages that the
subscription is prepared to lease at a given time. This maximum defaults
to 1 when there is no maximum explicitly specified for a subscription.
AMPS will lease the number specified in the subscription or the maximum
set for the queue, whichever is lower.</p>
<p>Notice that this does not set a limit of any sort on the capacity of the
queue. This parameter allows you to limit the number of messages that
the queue will make available for a single subscription at a given time,
but does not restrict the capacity of the queue to track messages.</p>
<p class="last">Default: <code class="docutils literal"><span class="pre">1</span></code></p>
</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">Expiration</span></code></td>
<td><p class="first">The length of time a message can remain in the queue before AMPS
considers the message undeliverable.</p>
<p>Messages may expire while a subscriber has a lease on the message. AMPS
does not send an additional notification in this case.</p>
<p>A publisher can override this setting by providing an expiration
value on an incoming message. If an individual message in the
transaction log has an expiration value, AMPS will use that expiration
value for the message rather than the default for the queue.</p>
<p class="last">Default: <code class="docutils literal"><span class="pre">infinite</span></code></p>
</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">Filter</span></code></td>
<td><p class="first">An AMPS <code class="docutils literal"><span class="pre">Filter</span></code> that is applied to the <code class="docutils literal"><span class="pre">UnderlyingTopic</span></code>. When a
<code class="docutils literal"><span class="pre">Filter</span></code> is specified, only messages matching the <code class="docutils literal"><span class="pre">Filter</span></code> appear in
the queue.</p>
<p class="last">By default, there is no filter and all messages from the UnderlyingTopic
are presented in the queue.</p>
</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">RecoveryPoint</span></code></td>
<td><p class="first">This option allows you to specify the point at which AMPS begins
reviewing the transaction log to recover the state of the queue when
AMPS restarts. By default, AMPS reviews the full log to determine the
contents and state of the queue.</p>
<p>The <code class="docutils literal"><span class="pre">RecoveryPoint</span></code> can be one of the following:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">epoch</span></code> - Recovery begins at the beginning of the transaction log</li>
<li><code class="docutils literal"><span class="pre">now</span></code> - Recovery begins at the time AMPS starts queue recovery,
so only new messages are added to the queue</li>
<li><code class="docutils literal"><span class="pre">creation</span></code> - Recovery begins at the time the queue was created</li>
<li>AMPS bookmark - When an AMPS bookmark is provided, AMPS starts
recovery at the specified bookmark.</li>
<li>ISO-8601 timestamp - When a timestamp is provided, AMPS starts
recovery at the specified timestamp. The timestamp must be
provided in the format AMPS uses for timestamp bookmarks.</li>
</ul>
<p class="last">Default: <code class="docutils literal"><span class="pre">epoch</span></code></p>
</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">FairnessModel</span></code></td>
<td><p class="first">AMPS provides different methods to distribute messages across active
subscriptions:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">fast</span></code> - AMPS delivers to the first subscription found that can
process the message</li>
<li><code class="docutils literal"><span class="pre">round-robin</span></code> - AMPS distributes to the next subscription found
that can process the message</li>
<li><code class="docutils literal"><span class="pre">proportional</span></code> - AMPS delivers to the subscription with the
lowest ratio of active messages to available backlog</li>
</ul>
<p class="last">Default: <code class="docutils literal"><span class="pre">proportional</span></code> for <code class="docutils literal"><span class="pre">at-least-once</span></code> queues, <code class="docutils literal"><span class="pre">round-robin</span></code>
for <code class="docutils literal"><span class="pre">at-most-once</span></code> queues</p>
</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">Leasing</span></code></td>
<td><p class="first">Ownership model for leased messages. AMPS supports the following models:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">strict</span></code> - AMPS allows a client to acknowledge (<code class="docutils literal"><span class="pre">sow_delete</span></code>)
only messages that are leased to the client or currently unleased.
If a client acknowledges a message leased to another client, there is
no effect.</li>
<li><code class="docutils literal"><span class="pre">sublet</span></code> - AMPS allows any client to acknowledge any message,
regardless of whether another client has a lease on the message.</li>
</ul>
<p class="last">Default: <code class="docutils literal"><span class="pre">sublet</span></code></p>
</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">MaxDeliveries</span></code></td>
<td><p class="first">Specifies an upper bound to the number of times AMPS may deliver a queue
message before automatically expiring it. For example if AMPS delivers
a message twice and <code class="docutils literal"><span class="pre">MaxDeliveries</span></code> is set to <code class="docutils literal"><span class="pre">2</span></code>, the message will
be expired if the subscriber disconnects or unsubscribes before
acknowledging it.</p>
<p>This counter is reset if the server restarts, and the counter is not
replicated to other instances.</p>
<p class="last">Default: no maximum (<code class="docutils literal"><span class="pre">0</span></code>).</p>
</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">MaxCancels</span></code></td>
<td><p class="first">Specifies a limit to the number of times a subscriber may cancel a lease
on a message before it is expired. For example if a message is canceled
for the second time and <code class="docutils literal"><span class="pre">MaxCancels</span></code> is set to 2, AMPS automatically
expires the message instead of returning it to the message queue.</p>
<p>This counter is reset if the server restarts, and the counter is not
replicated to other instances.</p>
<p class="last">Default: no maximum (<code class="docutils literal"><span class="pre">0</span></code>).</p>
</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">Priority</span></code></td>
<td><p class="first">Specifies the order in which messages will be distributed from the
queue. When present, this element constructs a value that specifies
the priority for messages in the queue. Higher priority messages are
delivered first, regardless of the order in which messages have been
published to the queue.</p>
<p>The contents of the element can be either the name of a field in the
message or an AMPS expression. Either way, the result is treated as an
<code class="docutils literal"><span class="pre">unsigned</span> <span class="pre">long</span></code> value.</p>
<p>For example, to order message delivery based on the <code class="docutils literal"><span class="pre">/priority</span></code> field
of the message, specify the following element:</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;Priority&gt;</span>/priority<span class="nt">&lt;/Priority&gt;</span>
</pre></div>
</div>
<p>To order message delivery based on the product of the <code class="docutils literal"><span class="pre">/price</span></code> field
and the <code class="docutils literal"><span class="pre">/quantity</span></code> field in the message, specify the following
element.</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;Priority&gt;</span>/price * /qty<span class="nt">&lt;/Priority&gt;</span>
</pre></div>
</div>
<p class="last">Default: there is no default for this value. When not provided, the
delivery order is the order in which messages were processed by this
instance of AMPS</p>
</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">DeferredAckExpiration</span></code></td>
<td><p class="first">Specifies the amount of time for AMPS to retain information about an
acknowledgement (<code class="docutils literal"><span class="pre">sow_delete</span></code>) message received when the corresponding
message is not in the queue. This can occur during failover, when
messages are received over replication, or in cases where an application
that uses a publish store has been offline for an extended period of
time.</p>
<p>This element is configured as an interval, for example, <code class="docutils literal"><span class="pre">15m</span></code> or
<code class="docutils literal"><span class="pre">2h</span></code>.</p>
<p class="last">Default: <code class="docutils literal"><span class="pre">1d</span></code></p>
</td>
</tr>
</tbody>
</table>
<p><strong>Table 15.2:</strong> <em>Queue configuration elements</em></p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- Notice that the topics to use for the queue (ORDERS_.*) must be</span>
<span class="c">    recorded in a transaction log. --&gt;</span>
<span class="nt">&lt;SOW&gt;</span>
    <span class="nt">&lt;Queue&gt;</span>
        <span class="nt">&lt;Name&gt;</span>MQ<span class="nt">&lt;/Name&gt;</span>
        <span class="nt">&lt;MessageType&gt;</span>json<span class="nt">&lt;/MessageType&gt;</span>
        <span class="nt">&lt;UnderlyingTopic&gt;</span>ORDERS_.*<span class="nt">&lt;/UnderlyingTopic&gt;</span>
        <span class="nt">&lt;DefaultPublishTarget&gt;</span>ORDERS_DIRECT<span class="nt">&lt;/DefaultPublishTarget&gt;</span>
        <span class="nt">&lt;LeasePeriod&gt;</span>60s<span class="nt">&lt;/LeasePeriod&gt;</span>
        <span class="nt">&lt;Expiration&gt;</span>1d<span class="nt">&lt;/Expiration&gt;</span>
        <span class="nt">&lt;MaxBacklog&gt;</span>3<span class="nt">&lt;/MaxBacklog&gt;</span>
    <span class="nt">&lt;/Queue&gt;</span>
<span class="nt">&lt;/SOW&gt;</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;2017 60East Technologies, Inc.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>